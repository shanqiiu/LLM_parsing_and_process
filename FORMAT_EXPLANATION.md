# æ–°æ ¼å¼JSONè¦æ±‚è¯´æ˜

## æ¦‚è¿°

ç³»ç»Ÿç°åœ¨**åªæ”¯æŒæ–°æ ¼å¼çš„JSONæ–‡ä»¶**ï¼Œæ‰€æœ‰çŸ¥è¯†åº“ä¸­çš„JSONæ–‡ä»¶å¿…é¡»åŒ…å« `def` å­—æ®µã€‚è¿™æ˜¯ç³»ç»Ÿçš„å”¯ä¸€æ”¯æŒæ ¼å¼ï¼Œä¸å†å…¼å®¹æ—§æ ¼å¼ã€‚

## æ–°æ ¼å¼å®šä¹‰

### å¿…éœ€å­—æ®µï¼š`def`

æ¯ä¸ªJSONæ–‡ä»¶**å¿…é¡»**åŒ…å«ä¸€ä¸ª `def` å­—æ®µï¼Œè¯¥å­—æ®µæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ˆå­—å…¸ï¼‰ï¼ŒåŒ…å«æ“ä½œåºåˆ—çš„æ ¸å¿ƒä¿¡æ¯ã€‚

### åŸºæœ¬ç»“æ„

```json
{
  "chunk_id": "...",
  "def": {
    // è¿™æ˜¯å¿…éœ€çš„æ ¸å¿ƒå­—æ®µ
    "substep": [...],           // å­æ­¥éª¤åˆ—è¡¨
    "current_main_step": {...}, // å½“å‰ä¸»æ­¥éª¤
    "operation": "...",         // æ“ä½œåç§°
    "id": "...",               // æ“ä½œID
    "source": "...",           // æºæ–‡ä»¶åç§°
    // ... å…¶ä»–å­—æ®µ
  },
  "filename": "...",
  "meta_data": {
    "mtime": "...",
    // ...
  },
  // ... å…¶ä»–å­—æ®µ
}
```

## ä¸ºä»€ä¹ˆå¿…é¡»åŒ…å« `def` å­—æ®µï¼Ÿ

### 1. ç»Ÿä¸€æ•°æ®ç»“æ„

`def` å­—æ®µæä¾›äº†ç»Ÿä¸€çš„æ•°æ®ç»“æ„ï¼Œç¡®ä¿æ‰€æœ‰æ“ä½œåºåˆ—ä¿¡æ¯éƒ½æŒ‰ç…§ç›¸åŒçš„æ ¼å¼ç»„ç»‡ï¼š

- **`def.substep`**: å­˜å‚¨è¯¦ç»†çš„å­æ­¥éª¤åˆ—è¡¨
- **`def.current_main_step`**: å­˜å‚¨å½“å‰ä¸»æ­¥éª¤ä¿¡æ¯
- **`def.operation`**: æ“ä½œåç§°
- **`def.context`**: æ“ä½œä¸Šä¸‹æ–‡
- **`def.source`**: æºæ–‡ä»¶åç§°

### 2. ä»£ç ç®€åŒ–

é€šè¿‡è¦æ±‚æ‰€æœ‰æ–‡ä»¶éƒ½åŒ…å« `def` å­—æ®µï¼Œä»£ç å¯ä»¥ï¼š

- ç›´æ¥è®¿é—® `operation_data["def"]["substep"]` è€Œä¸éœ€è¦åˆ¤æ–­æ ¼å¼
- ç§»é™¤æ‰€æœ‰æ ¼å¼å…¼å®¹æ€§æ£€æŸ¥ä»£ç 
- ç®€åŒ–æ•°æ®è®¿é—®é€»è¾‘

### 3. æ•°æ®å®Œæ•´æ€§

`def` å­—æ®µç¡®ä¿æ¯ä¸ªæ“ä½œåºåˆ—éƒ½åŒ…å«å®Œæ•´çš„ä¿¡æ¯ï¼š

```python
# ä»£ç ä¸­çš„éªŒè¯é€»è¾‘
if "def" not in operation_data or not isinstance(operation_data.get("def"), dict):
    print(f"âš  è­¦å‘Š: {json_file.name} ä¸æ˜¯æ–°æ ¼å¼ï¼ˆç¼ºå°‘defå­—æ®µï¼‰ï¼Œè·³è¿‡")
    continue
```

## ä»£ç å®ç°

### çŸ¥è¯†åº“åŠ è½½æ—¶çš„éªŒè¯

åœ¨ `knowledge_base.py` ä¸­ï¼ŒåŠ è½½æ¯ä¸ªJSONæ–‡ä»¶æ—¶ä¼šè¿›è¡Œä¸¥æ ¼éªŒè¯ï¼š

```python
def load(self) -> None:
    """ä»ç›®å½•åŠ è½½æ‰€æœ‰JSONæ–‡ä»¶"""
    for json_file in json_files:
        operation_data = json.load(f)
        
        # éªŒè¯æ–°æ ¼å¼ï¼šå¿…é¡»åŒ…å«defå­—æ®µ
        if "def" not in operation_data or not isinstance(operation_data.get("def"), dict):
            print(f"âš  è­¦å‘Š: {json_file.name} ä¸æ˜¯æ–°æ ¼å¼ï¼ˆç¼ºå°‘defå­—æ®µï¼‰ï¼Œè·³è¿‡")
            continue  # è·³è¿‡ä¸ç¬¦åˆæ ¼å¼çš„æ–‡ä»¶
        
        # åªæœ‰åŒ…å«defå­—æ®µçš„æ–‡ä»¶æ‰ä¼šè¢«åŠ è½½
        def_data = operation_data.get("def", {})
        # ... å¤„ç†æ•°æ®
```

### æ•°æ®è®¿é—®

æ‰€æœ‰æ•°æ®è®¿é—®éƒ½åŸºäº `def` å­—æ®µï¼š

```python
def get_operation_steps(self, operation_name: str):
    """è·å–æ“ä½œæ­¥éª¤"""
    operation = self.get_operation_by_name(operation_name)
    if operation and "def" in operation:
        def_data = operation.get("def", {})
        return def_data.get("substep", [])  # ç›´æ¥ä»def.substepè·å–
    return None
```

## å®Œæ•´ç¤ºä¾‹

### ç¬¦åˆè¦æ±‚çš„JSONæ–‡ä»¶

```json
{
  "chunk_id": "chunk_001",
  "def": {
    "path": {
      "textual_path": "ç”¨æˆ·è®¤è¯/ç™»å½•ç³»ç»Ÿ",
      "path_uri": "/user/auth/login"
    },
    "substep": [
      {
        "subtype": "action",
        "description": "æ‰“å¼€ç™»å½•é¡µé¢",
        "id": "step_001",
        "type": "operation"
      },
      {
        "subtype": "input",
        "description": "è¾“å…¥ç”¨æˆ·å",
        "id": "step_002",
        "type": "form_fill"
      }
    ],
    "current_main_step": {
      "subtype": "main",
      "description": "ç™»å½•ç³»ç»Ÿ",
      "id": "main_step_001",
      "type": "main_operation"
    },
    "operation": "ç™»å½•ç³»ç»Ÿ",
    "id": "operation_001",
    "source": "example_001.json",
    "context": "ç”¨æˆ·éœ€è¦ç™»å½•ç³»ç»Ÿä»¥è®¿é—®ä¸ªäººè´¦æˆ·",
    "scene": "ç”¨æˆ·ç™»å½•åœºæ™¯"
  },
  "filename": "example_001.json",
  "meta_data": {
    "mtime": "2024-01-01T00:00:00"
  }
}
```

### ä¸ç¬¦åˆè¦æ±‚çš„JSONæ–‡ä»¶ï¼ˆä¼šè¢«è·³è¿‡ï¼‰

```json
{
  "operation_id": "operation_001",
  "operation_name": "ç™»å½•ç³»ç»Ÿ",
  "steps": [
    "æ­¥éª¤1",
    "æ­¥éª¤2"
  ]
}
```

è¿™ä¸ªæ–‡ä»¶**æ²¡æœ‰** `def` å­—æ®µï¼Œç³»ç»Ÿä¼šï¼š
1. æ£€æµ‹åˆ°ç¼ºå°‘ `def` å­—æ®µ
2. æ‰“å°è­¦å‘Šä¿¡æ¯
3. è·³è¿‡è¯¥æ–‡ä»¶ï¼Œä¸åŠ è½½åˆ°çŸ¥è¯†åº“ä¸­

## ç³»ç»Ÿè¡Œä¸º

### åŠ è½½çŸ¥è¯†åº“æ—¶

```
âœ“ æˆåŠŸåŠ è½½çŸ¥è¯†åº“: 3 ä¸ªæ“ä½œä»ç›®å½• data/knowledge_base
âš  è­¦å‘Š: old_format.json ä¸æ˜¯æ–°æ ¼å¼ï¼ˆç¼ºå°‘defå­—æ®µï¼‰ï¼Œè·³è¿‡
```

### å¦‚æœæ‰€æœ‰æ–‡ä»¶éƒ½ä¸ç¬¦åˆæ ¼å¼

```
âš  è­¦å‘Š: file1.json ä¸æ˜¯æ–°æ ¼å¼ï¼ˆç¼ºå°‘defå­—æ®µï¼‰ï¼Œè·³è¿‡
âš  è­¦å‘Š: file2.json ä¸æ˜¯æ–°æ ¼å¼ï¼ˆç¼ºå°‘defå­—æ®µï¼‰ï¼Œè·³è¿‡
âŒ RuntimeError: æœªèƒ½åŠ è½½ä»»ä½•æœ‰æ•ˆçš„JSONæ–‡ä»¶
```

## è¿ç§»æŒ‡å—

å¦‚æœæ‚¨æœ‰æ—§æ ¼å¼çš„JSONæ–‡ä»¶ï¼Œéœ€è¦è½¬æ¢ä¸ºæ–°æ ¼å¼ï¼š

### æ—§æ ¼å¼
```json
{
  "operation_name": "ç™»å½•ç³»ç»Ÿ",
  "steps": ["æ­¥éª¤1", "æ­¥éª¤2"]
}
```

### è½¬æ¢ä¸ºæ–°æ ¼å¼
```json
{
  "def": {
    "operation": "ç™»å½•ç³»ç»Ÿ",
    "substep": [
      {
        "subtype": "action",
        "description": "æ­¥éª¤1",
        "id": "step_001",
        "type": "operation"
      },
      {
        "subtype": "action",
        "description": "æ­¥éª¤2",
        "id": "step_002",
        "type": "operation"
      }
    ],
    "current_main_step": {
      "subtype": "main",
      "description": "ç™»å½•ç³»ç»Ÿ",
      "id": "main_step_001",
      "type": "main_operation"
    }
  }
}
```

## æ€»ç»“

- âœ… **å¿…é¡»**ï¼šæ‰€æœ‰JSONæ–‡ä»¶å¿…é¡»åŒ…å« `def` å­—æ®µ
- âœ… **ä¸¥æ ¼éªŒè¯**ï¼šç³»ç»Ÿä¼šæ£€æŸ¥æ¯ä¸ªæ–‡ä»¶çš„æ ¼å¼
- âœ… **è‡ªåŠ¨è·³è¿‡**ï¼šä¸ç¬¦åˆæ ¼å¼çš„æ–‡ä»¶ä¼šè¢«è·³è¿‡å¹¶æ˜¾ç¤ºè­¦å‘Š
- âŒ **ä¸æ”¯æŒ**ï¼šæ—§æ ¼å¼æ–‡ä»¶ä¸ä¼šè¢«åŠ è½½
- ğŸ¯ **ç›®æ ‡**ï¼šç¡®ä¿æ•°æ®æ ¼å¼ç»Ÿä¸€ï¼Œä»£ç ç®€æ´é«˜æ•ˆ

